var EvernoteAuth=function(){"use strict";var conf=EvernoteAuthConf,redirectURL="https://"+chrome.runtime.id+".chromiumapp.org/auth/callback",redirectRe=new RegExp(redirectURL+"[#?](.*)"),access_token=null;return{getToken:function(type,callback){function parseRedirectFragment(fragment,options){var pairs=fragment.split(/&/),values={};return pairs.forEach(function(pair){var nameval=pair.split(/=/);values[nameval[0]]=options&&options.decode?decodeURIComponent(nameval[1]):nameval[1]}),values}function handleProviderResponse(values,values2){console.log("providerResponse",values),values.hasOwnProperty("access_token")?setAccessToken(values.access_token):values.hasOwnProperty("oauth_token")?exchangeCodeForToken(values.oauth_token,values2.oauth_verifier):callback(new Error("Neither access_token nor code avialable."))}function exchangeCodeForToken(token,verifier){var xhr=new XMLHttpRequest;xhr.open("POST",conf.hostname[type]+"/oauth?oauth_consumer_key="+conf.consumer_key+"&oauth_signature="+conf.consumer_secret+"%26&oauth_signature_method=PLAINTEXT&oauth_timestamp="+(new Date).valueOf()+"&oauth_nonce="+(new Date).valueOf()+"&oauth_token="+token+"&oauth_verifier="+verifier),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.onload=function(){if(200===this.status){var response=parseRedirectFragment(this.responseText,{decode:!0});console.log(response),response.hasOwnProperty("oauth_token")?callback(null,response):callback(new Error("Cannot obtain access_token from code."))}else console.log("code exchange status:",this.status),callback(new Error("Code exchange failed"))},xhr.send()}if(access_token)return void callback(null,access_token);var options={interactive:!0,url:conf.hostname[type]+"/oauth?oauth_consumer_key="+conf.consumer_key+"&oauth_signature="+conf.consumer_secret+"%26&oauth_signature_method=PLAINTEXT&oauth_timestamp="+(new Date).valueOf()+"&oauth_nonce"+(new Date).valueOf()+"&oauth_callback="+encodeURIComponent(redirectURL)},xhr=new XMLHttpRequest;xhr.open("GET",options.url),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.onload=function(){if(200===this.status){var resp=parseRedirectFragment(this.responseText);if(console.log(resp),!resp.oauth_callback_confirmed)return;chrome.identity.launchWebAuthFlow({interactive:!0,url:conf.hostname[type]+"/OAuth.action?oauth_token="+resp.oauth_token},function(redirectUri){if(console.log("launchWebAuthFlow completed",chrome.runtime.lastError,redirectUri),chrome.runtime.lastError)return void callback(new Error(chrome.runtime.lastError));var matches=redirectUri.match(redirectRe);matches&&matches.length>1?handleProviderResponse(resp,parseRedirectFragment(redirectUri)):callback(new Error("Invalid redirect URI"))})}},xhr.send()}}}();