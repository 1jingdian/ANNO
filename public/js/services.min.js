"use strict";angular.module("ANNO").factory("AuthService",["$http","$location",function($http,$location){return{auth:function(){DoubanAuth.getToken(function(error,access_token){error||$http({method:"GET",url:"https://api.douban.com/v2/user/~me",headers:{Authorization:"Bearer "+access_token}}).success(function(resp){chrome.storage.local.set({logintoken:JSON.stringify({id:resp.id,uid:resp.uid,avatar:resp.large_avatar,token:access_token})}),$location.path("/")})})}}}]).factory("UserService",function($rootScope,$http,$q){return{isLoggedIn:function(){var defer=new $q.defer;return chrome.storage.local.get("logintoken",function(resp){!_.isEmpty(resp)&&resp.logintoken?defer.resolve():defer.reject()}),defer.promise},getUser:function(uid){var defer=new $q.defer,self=this;return this.login().then(function(user){uid=uid||user.uid,user.uid==uid?(user.is_self=!0,defer.resolve(user)):self.getUserInfo(uid).then(function(user){user.is_self=!1,defer.resolve(_.pick(user,"id","uid","name"))})},function(){defer.reject()}),defer.promise},getUserInfo:function(uid){var defer=new $q.defer;return this.login().then(function(user){uid=uid||user.uid,$http({method:"GET",url:"/api/v2/user/"+uid,cache:!0}).success(function(userinfo){defer.resolve(userinfo)})},function(){defer.reject()}),defer.promise},login:function(){var defer=new $q.defer;return chrome.storage.local.get("logintoken",function(resp){resp.logintoken?($rootScope.user=JSON.parse(resp.logintoken),defer.resolve($rootScope.user)):defer.reject()}),defer.promise},logout:function(callback){chrome.storage.local.remove("logintoken",function(){$rootScope.user=null,callback()})}}}).factory("SerializeService",function($q,$http,$rootScope,BookService){function sync(url,start,count,callback){sync.books=sync.books||{},sync.notes=sync.notes||[],$http({method:"GET",url:url,params:{start:start,count:count}}).success(function(resp){var book,annotations=resp.annotations,books=sync.books,notes=sync.notes;annotations.forEach(function(note){notes.push(_.pick(note,"id","book_id","chapter","time","summary","content","privacy","page_no","last_photo","photos")),book=_.pick(note.book,"id","title","author","images","summary"),books[book.id]?books[book.id].notes_count+=1:books[book.id]=_.extend(book,{notes_count:1})}),annotations.length?sync(url,start+count,count,callback):callback()})}return{serialize:function(id,callback){sync.books={},sync.notes=[],sync("/api/v2/book/user/"+id+"/annotations",0,20,function(){sessionStorage.setItem(id+"_books",JSON.stringify(sync.books)),sessionStorage.setItem(id+"_notes",JSON.stringify(sync.notes)),callback(sync.books,sync.notes)})},fetchAllBooks:function(id){var defer=new $q.defer,books=sessionStorage.getItem(id+"_books");return books?(books=JSON.parse(books),defer.resolve(books)):this.serialize(id,function(books){defer.resolve(books)}),defer.promise},fetchBook:function(uid,bid){var book,notes,defer=new $q.defer,books=sessionStorage.getItem(uid+"_books");return books&&(books=JSON.parse(books),book=books[bid]),book?(notes=JSON.parse(sessionStorage.getItem(uid+"_notes")),notes=notes.filter(function(note){return note.book_id==bid}),book.notes=notes,defer.resolve(book)):this.serialize(uid,function(books,notes){book=books[bid],book?(book.notes=notes.filter(function(note){return note.book_id==book.id}),defer.resolve(book)):BookService.get(bid).then(function(book){book.notes_count=0,book.notes=[],defer.resolve(book)})}),defer.promise},fetchAll:function(uid){var defer=new $q.defer,books=sessionStorage.getItem(uid+"_books"),notes=sessionStorage.getItem(uid+"_notes");return books&&notes?(books=JSON.parse(books),notes=JSON.parse(notes),defer.resolve([books,notes])):this.serialize(uid,function(books,notes){defer.resolve([books,notes])}),defer.promise}}}).factory("TranslateService",function(){var _Detab=function(text){return text=text.replace(/\t(?=\t)/g,"    "),text=text.replace(/\t/g,"~A~B"),text=text.replace(/~B(.+?)~A/g,function(wholeMatch,m1){for(var leadingText=m1,numSpaces=4-leadingText.length%4,i=0;numSpaces>i;i++)leadingText+=" ";return leadingText}),text=text.replace(/~A/g,"    "),text=text.replace(/~B/g,"")};return{doubanToMarkdown:function(text,images){return images&&!_.isEmpty(images)&&(text=text.replace(/\<图片(\d*)\>/g,function(_,num){return"![图片"+num+"]("+images[num]+")"})),text.replace(/\<代码开始 lang=\"(.*)\"\>(\n{0,1})/g,"```$1\n").replace(/\<\/代码结束\>/g,"```").replace(/\[code:(.*)\]/g,"```$1").replace(/\[\/code\]/g,"```").replace(/\<原文开始\>([\s\S]*?)\<\/原文结束\>/g,function(wholeMatch,m1){var bq=m1;return bq=bq.replace(/^\n/g,""),bq=bq.replace(/^([^\n|^\s])/gm,"> $1")})},markdownToDouban:function(text){return text+="\n",text.replace(/(^|\n)```(.*)\n([\s\S]*?)\n```/g,function(wholeMatch,m0,m1,m2){var blank=m0,language=m1,codeblock=m2;return codeblock=_Detab(codeblock),codeblock=codeblock.replace(/^\n+/g,""),codeblock=codeblock.replace(/\n+$/g,""),codeblock=blank+"<代码开始"+(language?' lang="'+language+'"':"")+">\n"+codeblock+"\n</代码结束>"}).replace(/\!\[图片(\d*)\]\((.*)\)/g,"<图片$1>").replace(/((^[ \t]*>[ \t]?.+\n(.+\n)*\n*)+)/gm,function(wholeMatch,m1){var bq=m1;return bq=bq.replace(/^[ \t]*>[ \t]?/gm,"~0"),bq=bq.replace(/~0/g,""),bq=bq.replace(/^[ \t]+$/gm,""),bq=bq.replace(/\n{1,}$/,""),"<原文开始>\n"+bq+"\n</原文结束>\n"}).replace(/\n$/g,"")}}}).factory("NoteService",["$http","$rootScope","UserService",function($http,$rootScope){function increaseNoteCount(bid,delta){delta=delta||1;var books=JSON.parse(sessionStorage.getItem(STORAGE_BOOK)),book=books[bid];book&&(book.notes_count+=delta,sessionStorage.setItem(STORAGE_BOOK,JSON.stringify(books)))}var user=$rootScope.user,id=user.id,STORAGE_BOOK=id+"_books",STORAGE_NOTE=id+"_notes",buildFormData=function(payload,files){var formData=new FormData;return _.each(payload,function(val,key){formData.append(key,val)}),_.each(files,function(file){formData.append(file.name,file.obj)}),formData};return{get:function(params){return $http.get("/api/v2/book/annotation/"+params.id)},put:function(params,payload,photos){var formData=buildFormData(payload,photos);return $http.put("/api/v2/book/annotation/"+params.id,formData,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(note){var notes=sessionStorage.getItem(STORAGE_NOTE);notes&&(notes=JSON.parse(notes),notes.forEach(function(n,i){n.id==note.id&&(notes[i]=note)}),sessionStorage.setItem(STORAGE_NOTE,JSON.stringify(notes)))})},post:function(params,payload,photos){var formData=buildFormData(payload,photos);return $http.post("/api/v2/book/"+params.bid+"/annotations",formData,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(note){var notes=sessionStorage.getItem(STORAGE_NOTE);notes&&(notes=JSON.parse(notes),notes.push(note),sessionStorage.setItem(STORAGE_NOTE,JSON.stringify(notes)),increaseNoteCount(note.book_id))})},remove:function(params){var id=params.id,bid=params.bid;return $http.delete("/api/v2/book/annotation/"+id).success(function(){var notes=sessionStorage.getItem(STORAGE_NOTE);notes&&(notes=JSON.parse(notes),notes=notes.filter(function(note){return note.id!=id}),sessionStorage.setItem(STORAGE_NOTE,JSON.stringify(notes)),increaseNoteCount(bid,-1))})}}}]).factory("BookService",["$q","$http","UserService",function($q,$http,UserService){return{get:function(bid){var book,user=UserService.login(),id=user.id,defer=$q.defer(),books=sessionStorage.getItem(id+"_books");return books&&(books=JSON.parse(books),book=books[bid]),book?defer.resolve(book):$http.get("/api/v2/book/"+bid).success(function(book){defer.resolve(book)}),defer.promise}}}]).factory("HttpLoadingIntercepter",["$q","$rootScope",function($q,$rootScope){var n_loading=0;return{request:function(config){return n_loading++,$rootScope.$broadcast("loading:show"),config||$q.when(config)},requestError:function(rejection){return n_loading--,$q.reject(rejection)},response:function(response){return--n_loading||$rootScope.$broadcast("loading:hide"),response||$q.when(response)},responseError:function(rejection){return $rootScope.$broadcast("alert:error",rejection.data),--n_loading||$rootScope.$broadcast("loading:hide"),$q.reject(rejection)}}}]).factory("HttpOAuthIntercepter",["$q","$rootScope",function($q,$rootScope){return{request:function(req){return 0==req.url.indexOf("/api")&&(req.headers.Authorization="Bearer "+$rootScope.user.token,req.url="https://api.douban.com"+req.url.slice(4)),req}}}]).factory("FavouriteService",["$rootScope",function($rootScope){var storage=chrome.storage.sync,STORAGE_STAR=$rootScope.user.id+"_favourites";return{getState:function(note,cb){this.fetchAll(function(favourites){var is_faved=!1;_.each(favourites,function(n){n.id==note.id&&(is_faved=!0)}),cb(is_faved)})},star:function(note,cb){this.fetchAll(function(favourites){favourites.push(note);var item={};item[STORAGE_STAR]=favourites,storage.set(item,function(){cb({is_starred:!0})})})},unstar:function(note,cb){this.fetchAll(function(favourites){favourites=favourites.filter(function(n){return n.id!=note.id});var item={};item[STORAGE_STAR]=favourites,storage.set(item,function(){cb({is_starred:!1})})})},fetchAll:function(callback){storage.get(STORAGE_STAR,function(resp){callback(resp&&resp[STORAGE_STAR]?resp[STORAGE_STAR]:[])})}}}]).factory("FileSystemService",[function(){function errorHandler(e){console.error(e)}function waitForIO(writer,callback){var start=Date.now(),reentrant=function(){return writer.readyState===writer.WRITING&&Date.now()-start<4e3?void setTimeout(reentrant,100):void(writer.readyState===writer.WRITING?(console.error("Write operation taking too long, aborting! (current writer readyState is "+writer.readyState+")"),writer.abort()):callback())};setTimeout(reentrant,100)}function writeEntry(writableEntry,opt_blob,callback){writableEntry.createWriter(function(writer){writer.onerror=errorHandler,writer.onwriteend=callback,opt_blob&&(writer.truncate(opt_blob.size),waitForIO(writer,function(){writer.seek(0),writer.write(opt_blob)}))},errorHandler)}return{save:function(blob,filename,extension,callback){chrome.fileSystem.chooseEntry({type:"saveFile",suggestedName:filename,accepts:[{extensions:[extension]}]},function(writableEntry){return writableEntry?void writeEntry(writableEntry,blob,function(){callback(!0)}):void callback(!1)})}}}]);