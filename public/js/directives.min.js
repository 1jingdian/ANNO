"use strict";angular.module("ANNO.directives",[]).directive("inputEnter",function(){var ENTER_KEY=13;return function(scope,elem,attrs){elem.bind("keydown",function(event){event.keyCode===ENTER_KEY&&scope.$apply(attrs.inputEnter)})}}).directive("editor",["$modal",function($modal){return{restrict:"E",replace:!0,templateUrl:"/partials/widgets/editor.html",scope:{article:"=",images:"="},controller:function($scope){var utils={bold:function(s,editor){editor.replaceSelection("*"===s.charAt(0)&&s.charAt(s.length-1==="*")?s.replace(/\*/g,""):"**"+s.replace(/\*/g,"")+"**")},italic:function(s,editor){editor.replaceSelection("_"===s.charAt(0)&&s.charAt(s.length-1==="_")?s.replace(/_/g,""):"_"+s.replace(/_/g,"")+"_")},quote:function(s,editor){editor.replaceSelection(">"===s.charAt(0)?util.lTrim(s.replace(/\>/g,"")):"> "+s.replace(/\>/g,""))}},self=this;this.codeMirrorLoad=function(editor){$scope.bold=function(){""!==editor.getSelection()&&utils.bold(editor.getSelection(),editor)},$scope.italic=function(){""!==editor.getSelection()&&utils.italic(editor.getSelection(),editor)},$scope.quote=function(){""!==editor.getSelection()&&utils.quote(editor.getSelection(),editor)},self.uploadPhoto=function(dataURL,file){$scope.article.last_photo=$scope.article.last_photo||0,++$scope.article.last_photo,$scope.images.push({name:"pic"+$scope.article.last_photo,src:dataURL,obj:file}),editor.replaceSelection("<图片"+$scope.article.last_photo+">")},$scope.toggleEditorHelp=function(){$modal.open({templateUrl:"modalEditorHelp.html",controller:function($scope,$modalInstance){$scope.ok=function(){$modalInstance.close()}}})}}}}}]).directive("codemirror",function(){return{restrict:"E",require:["^editor","ngModel"],replace:!0,link:function(scope,elem,attrs,ctrls){var editorCtrl=ctrls[0],ngModel=ctrls[1],editor=new CodeMirror(elem[0],{mode:"gfm",lineWrapping:!0,lineNumbers:!1,matchBrackets:!0,autofocus:!0,theme:"prose-bright",placeholder:"开始写笔记"});editor.refresh(),editor.on("change",function(cm){var phase=scope.$root.$$phase;"$apply"==phase||"$digest"==phase?ngModel.$setViewValue(cm.getValue()):scope.$apply(function(){ngModel.$setViewValue(cm.getValue())})}),ngModel.$render=function(){ngModel.$viewValue&&editor.setValue(ngModel.$viewValue)},editorCtrl.codeMirrorLoad(editor)}}}).directive("filereader",function(){return{restrict:"A",require:"^editor",link:function(scope,elem,attrs,editorCtrl){var reader=new FileReader;reader.onload=function(e){editorCtrl.uploadPhoto(e.target.result,elem[0].files[0])},elem.on("change",function(){reader.readAsDataURL(elem[0].files[0])})}}}).directive("reader",function(){return{restrict:"E",replace:!0,templateUrl:"/partials/widgets/reader.html",scope:{article:"=",images:"="},controller:function($scope){this.images=$scope.images}}}).directive("previewer",["$timeout","$http",function($timeout,$http){var imageCache={};return{restrict:"E",scope:{markdown:"=",images:"="},template:'<div class="content">{{markdown}}</div>',replace:!0,require:"^?reader",link:function(scope,elem){var renderer=new marked.Renderer;renderer.image=function(href,title,text){var out='<img data-src="'+href+'" alt="'+text+'"';return title&&(out+=' title="'+title+'"'),out+=this.options.xhtml?"/>":">"},renderer.link=function(href,title,text){if(this.options.sanitize){try{var prot=decodeURIComponent(unescape(href)).replace(/[^\w:]/g,"").toLowerCase()}catch(e){return""}if(0===prot.indexOf("javascript:"))return""}var out='<a href="'+href+'"';return title&&(out+=' title="'+title+'"'),out+=' target="_blank" >'+text+"</a>"},marked.setOptions({renderer:renderer,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,smartLists:!0,smartypants:!1}),scope.$watch("markdown",function(text){if(!_.isUndefined(text)){elem.html(marked(text));var MIME={c:"text/x-csrc",cpp:"text/x-c++src",csharp:"text/x-csharp",java:"text/x-java",lisp:"text/x-common-lisp"};Array.prototype.slice.call(elem.find("pre"),0).forEach(function(block){var $block=$(block),$code=$block.find("code");if($code.attr("class").length){var mode=$code.attr("class").slice(5);mode=MIME[mode]||mode,CodeMirror.runMode($block.text(),mode,block),$block.addClass("cm-s-prose-bright")}}),Array.prototype.slice.call(elem.find("img"),0).forEach(function(img){var $img=$(img),source=$img.attr("data-src");imageCache[source]?$img.attr("src",imageCache[source]):$http.get($img.attr("data-src"),{responseType:"blob",cache:!0}).success(function(blob){imageCache[source]=window.URL.createObjectURL(blob),Array.prototype.slice.call(elem.find("img"),0).forEach(function(new_img){$(new_img).attr("src",imageCache[source])})})}),elem.html(elem.html().replace(/\&lt;图片(\d+)\&gt;/g,function(wholeMatch,m1){var img=_.findWhere(scope.images,{name:"pic"+m1});return'<img src="'+img.src+'" />'}))}})}}}]).directive("loader",["$rootScope","$timeout",function($rootScope,$timeout){return function(scope,elem){scope.$on("loading:show",function(){elem.css("display","block").removeClass("fadeOut")}),scope.$on("loading:hide",function(){elem.addClass("fadeOut"),$timeout(function(){elem.css("display","none")},1e3)})}}]).directive("alert",["$rootScope","$timeout",function($rootScope,$timeout){return function(scope,elem){var ERROR={103:'访问令牌出错，需要<a href="/#/login">重新授权登录</a>',111:"访问太频繁，超出第三方应用限额",999:"未知错误",1000:"这篇笔记是私密的，只能阅读到简介部分，不能显示全文",1001:'内容不存在，<a link="/">回到我的书架</a>',1002:"必要的信息还没填完，请检查标题和内容是否填写",1003:"上传图片太大，不能大于3M",1004:"有违禁词",1005:"输入的正文太短，要求超过15个字",1008:"不支持上传图片的格式"};scope.$on("alert:error",function(e,data){var msg=ERROR[data.code];msg||(msg=data.code?"你遇到了编号为"+data.code+'的错误"'+data.msg:'发生了奇怪的错误，可能是服务器不稳定，稍后再试试吧。<a href="http://www.douban.com/doumail/write?to=1662222" target="_blank">告诉管理员让他修复错误吧。</a>'),elem.addClass("error").addClass("show").html(msg)}),scope.$on("alert:success",function(e,msg){elem.addClass("success").addClass("show").html(msg),$timeout(function(){scope.$emit("alert:dismiss")},2e3)}),elem.on("click",function(){elem.removeClass("show")}),scope.$on("alert:dismiss",function(){elem.removeClass("show")})}}]).directive("colorThief",["$http",function($http){return{restrict:"A",require:"ngModel",link:function(scope,elem,attrs,ngModel){var colorThief=new ColorThief,sourceImage=new Image;scope.$watch(attrs.image,function(url){url&&($http.get(url,{responseType:"blob",cache:"true"}).success(function(blob){sourceImage.src=window.URL.createObjectURL(blob)}),sourceImage.onload=function(){var rgb=colorThief.getColor(sourceImage),luma=.2126*rgb[0]+.7152*rgb[1]+.0722*rgb[2];ngModel.$setViewValue({background:"rgb("+rgb.join(",")+")",foreground:luma>192?"#000":"#fff"})})})}}}]).directive("link",function($location){return function(scope,element,attrs){element.bind("click",function(){scope.$apply($location.path(attrs.link))})}}).directive("remoteImage",["$http","$compile",function($http){function fetchImage(scope,elem,url){$http.get(url,{responseType:"blob",cache:!0}).success(function(blob){"IMG"===elem[0].nodeName?elem.attr("src",window.URL.createObjectURL(blob)):elem.css({"background-image":"url("+window.URL.createObjectURL(blob)+")"})})}return{link:function(scope,elem,attrs){scope.$watch(attrs.remoteImage,function(url){url&&fetchImage(scope,elem,url)})}}}]);